<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How Bad Actors Can Hide Outlook & Exchange Inbox Rules</title>
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>How Bad Actors Can Hide Outlook &amp; Exchange Inbox Rules | Ritchie Caruso</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="How Bad Actors Can Hide Outlook &amp; Exchange Inbox Rules" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="It was a typical Monday morning. I sat down at my desk, ready to start the day, when I received a Microsoft Teams message from our cybersecurity department. Over the weekend, a breach had occurred that impacted several users." />
<meta property="og:description" content="It was a typical Monday morning. I sat down at my desk, ready to start the day, when I received a Microsoft Teams message from our cybersecurity department. Over the weekend, a breach had occurred that impacted several users." />
<link rel="canonical" href="http://localhost:4000/2025/10/20/hidden-outlook-rules.html" />
<meta property="og:url" content="http://localhost:4000/2025/10/20/hidden-outlook-rules.html" />
<meta property="og:site_name" content="Ritchie Caruso" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-10-20T00:00:00+11:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="How Bad Actors Can Hide Outlook &amp; Exchange Inbox Rules" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-10-20T00:00:00+11:00","datePublished":"2025-10-20T00:00:00+11:00","description":"It was a typical Monday morning. I sat down at my desk, ready to start the day, when I received a Microsoft Teams message from our cybersecurity department. Over the weekend, a breach had occurred that impacted several users.","headline":"How Bad Actors Can Hide Outlook &amp; Exchange Inbox Rules","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/10/20/hidden-outlook-rules.html"},"url":"http://localhost:4000/2025/10/20/hidden-outlook-rules.html"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ritchie Caruso" />
    <link rel="icon" type="image/png" href="/assets/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg" />
    <link rel="shortcut icon" href="/assets/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Ritchie" />
    <link rel="manifest" href="/assets/images/site.webmanifest" />
    <link rel="stylesheet" href="/assets/css/style.css">
  </head>
  <body>
    <header class="site-header">
      <div class="site-title"><a href="/">Ritchie Caruso</a></div>
      <button id="hamburger" class="hamburger" aria-label="Toggle menu" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="site-right">
        <nav class="site-nav">
          <a href="/" >Home</a>
          <a href="/about/" >About</a>
          <a href="/projects/" >Projects</a>
          <a href="/blog/" class="active">Blog</a>
          <a href="/contact/" >Contact</a>
        </nav>
        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode" aria-pressed="false">
          <span class="knob" aria-hidden="true"></span>
        </button>
      </div>
    </header>

    <main class="site-main post-main">
      <article class="post">
        <h1 class="post-title">How Bad Actors Can Hide Outlook & Exchange Inbox Rules</h1>
        <div class="post-meta">October 20, 2025</div>
        
        <div class="post-tags" aria-label="Tags">
          
          <a class="tag-badge" href="/tags/#cybersecurity">cybersecurity</a>
          
          <a class="tag-badge" href="/tags/#microsoft">microsoft</a>
          
          <a class="tag-badge" href="/tags/#exchange">exchange</a>
          
          <a class="tag-badge" href="/tags/#outlook">outlook</a>
          
          <a class="tag-badge" href="/tags/#incident-response">incident-response</a>
          
        </div>
        
        
        <div class="post-hero-image">
          <img src="/assets/images/hidden-rules/hidden-rule-banner.webp" alt="How Bad Actors Can Hide Outlook & Exchange Inbox Rules">
        </div>
        
        <div class="post-content">
          <p>It was a typical Monday morning. I sat down at my desk, ready to start the day, when I received a Microsoft Teams message from our cybersecurity department. Over the weekend, a breach had occurred that impacted several users.</p>

<p>Without going into sensitive detail, the attacker had gained access to user accounts and distributed a phishing campaign via a SharePoint file.</p>

<p>My task that morning was straightforward:</p>

<ul>
  <li>Assist affected users with password resets</li>
  <li>Ensure multi-factor authentication (MFA) using an authenticator app was configured</li>
  <li>Restore access to their accounts</li>
</ul>

<p>After working through this process with several users, I noticed a strange pattern: <strong>none of them had received any emails since Friday</strong>.</p>

<p>At first glance, this didn’t seem alarming — it <em>was</em> the weekend — but something felt off. I sent a test email to one of the accounts. It never appeared in the inbox.</p>

<p>After searching Outlook, I discovered the message had arrived successfully, but it was sitting in the <strong>Archive</strong> folder, along with every other email received since Friday.</p>

<p>At this point, it became clear that an inbox rule was involved. However, when I checked the Outlook <em>Rules and Alerts</em> interface, <strong>no rules were visible</strong>.</p>

<p>After further research, I found multiple reports describing similar behaviour. That’s when I learned about a little-known — but highly effective — technique that allows attackers to <strong>hide Outlook/Exchange inbox rules from the Rules GUI entirely</strong>.</p>

<p>In this post, I’ll walk through:</p>

<ul>
  <li>How this attack works</li>
  <li>How attackers hide inbox rules</li>
  <li>How to detect hidden rules</li>
  <li>How to remove them at scale across an organisation</li>
</ul>

<p><br /></p>

<h2 id="the-attack">The Attack</h2>

<h3 id="how-is-the-attack-executed">How Is the Attack Executed?</h3>
<figure>
  <img src="/assets/images/hidden-rules/hidden-rule-attack.webp" alt="Hidden Rule Attack Steps" width="250" />
  <figcaption>Hidden Rule Attack Steps</figcaption>
</figure>

<p>In our environment, external email forwarding was blocked. Instead of forwarding messages, the attacker created a rule that silently moved emails out of sight — buying time before the user realised their account had been compromised.</p>

<p>These actions are well suited to scripting and automation—particularly the creation of the malicious rule and the subsequent steps to conceal it from Outlook clients.</p>

<p>For simplicity, we’ll assume the attacker has already <strong>completed steps 1 and 2</strong>:</p>

<ol>
  <li>Obtained valid credentials</li>
  <li>Logged into the victim’s mailbox via Outlook</li>
</ol>

<p><br /></p>

<h3 id="step-3-create-a-malicious-inbox-rule">Step 3: Create a Malicious Inbox Rule</h3>

<p>The attacker creates an inbox rule that forwards or moves emails — for example, to the attackers email.</p>

<figure>
  <img src="/assets/images/hidden-rules/create-rule.webp" alt="Creating Outlook rule" width="400" />
  <figcaption>Creating Outlook rule</figcaption>
</figure>

<p>At this stage, the rule is still visible in the <strong>Rules and Alerts</strong> window.</p>

<p><br /></p>

<h3 id="step-4-hide-the-rule">Step 4: Hide the Rule</h3>

<p>The next step is to make the rule nearly invisible.</p>

<p>This exploit abuses Microsoft’s <strong>Messaging API (MAPI)</strong>, a middleware layer that allows applications like Outlook to interact with mailbox data.</p>

<p>To demonstrate, I used <strong>MFCMapi</strong>, a Microsoft-provided diagnostic tool available on GitHub.</p>

<p>In this example, the rule moves emails with the subject <em>“Hidden Test”</em> to the Archive folder.</p>

<figure>
  <img src="/assets/images/hidden-rules/rule-demonstration.webp" alt="Rule that will be hidden" width="400" />
  <figcaption>Rule that will be hidden</figcaption>
</figure>

<h4 id="hiding-the-rule-with-mfcmapi">Hiding the Rule with MFCMapi</h4>

<ol>
  <li>Open the Inbox in <strong>MFCMapi</strong></li>
  <li>Navigate to <strong>Folder → View → Hidden Contents</strong></li>
  <li>Locate messages with the class <code class="language-plaintext highlighter-rouge">IPM.Rule.Version2.Message</code></li>
  <li>Open the rule and locate the following properties:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">PR_RULE_MSG_NAME</code></li>
      <li><code class="language-plaintext highlighter-rouge">PR_RULE_MSG_PROVIDER</code></li>
    </ul>
  </li>
  <li><strong>Clear the value fields</strong> for both properties</li>
</ol>

<figure>
  <img src="/assets/images/hidden-rules/mfcmapi-changes.webp" alt="Tampering with rule properties" width="600" />
  <figcaption>Tampering with rule properties</figcaption>
</figure>

<p>Once modified, the rule no longer appears in Outlook or standard administrative interfaces.</p>

<p><br /></p>

<h2 id="detecting-hidden-inbox-rules">Detecting Hidden Inbox Rules</h2>

<p>After hiding the rule, the <strong>Rules and Alerts</strong> window appears empty:</p>

<figure>
  <img src="/assets/images/hidden-rules/rule-is-hidden.webp" alt="No rules visible in Outlook" width="600" />
  <figcaption>No rules visible in Outlook</figcaption>
</figure>

<p>However, the rule is still active.</p>

<p>After sending a test email that meets the rule’s criteria, the message is silently moved to the Archive folder:</p>

<figure>
  <img src="/assets/images/hidden-rules/email-in-archive.webp" alt="Email moved by hidden rule" width="600" />
  <figcaption>Email moved by hidden rule</figcaption>
</figure>

<p><br /></p>

<h2 id="detecting-hidden-rules-with-powershell">Detecting Hidden Rules with PowerShell</h2>

<p>Manually inspecting mailboxes with MFCMapi does not scale. Fortunately, <strong>PowerShell provides visibility into hidden rules</strong>.</p>

<p>First, connect to Exchange Online:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Connect-ExchangeOnline</span><span class="w">
</span></code></pre></div></div>

<p>Then query inbox rules, including hidden ones:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-InboxRule</span><span class="w"> </span><span class="nt">-Mailbox</span><span class="w"> </span><span class="nx">example</span><span class="err">@</span><span class="nx">example.com</span><span class="w"> </span><span class="nt">-IncludeHidden</span><span class="w">
</span></code></pre></div></div>
<p>Hidden rules appear with a numeric string.</p>

<figure>
  <img src="/assets/images/hidden-rules/Get-InboxRule.webp" alt="Detecting hidden rule in Powershell" width="600" />
  <figcaption>Detecting hidden rule in Powershell</figcaption>
</figure>

<p><br /></p>

<h2 id="removing-hidden-rules">Removing Hidden Rules</h2>
<p>There are two effective removal methods.</p>

<h3 id="option-1-powershell-recommended">Option 1: Powershell (Recommended)</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Remove-InboxRule</span><span class="w"> </span><span class="nt">-Mailbox</span><span class="w"> </span><span class="nx">example</span><span class="err">@</span><span class="nx">work.com</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"RULE_ID"</span><span class="w">
</span></code></pre></div></div>

<figure>
  <img src="/assets/images/hidden-rules/remove-rule.webp" alt="Removing hidden rule in Powershell" width="800" />
  <figcaption>Removing hidden rule in Powershell</figcaption>
</figure>

<h3 id="option-2-outlook-clean-rules-flag">Option 2: Outlook Clean Rules Flag</h3>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>outlook.exe /cleanrules
</code></pre></div></div>
<figure>
  <img src="/assets/images/hidden-rules/clean-rules.webp" alt="Cleaning Outlook Rules" width="400" />
  <figcaption>Cleaning Outlook Rules</figcaption>
</figure>

<p>⚠️ Warning: This removes all inbox rules for the user.</p>

<p><br /></p>

<h2 id="scanning-the-entire-organisation">Scanning the Entire Organisation</h2>
<p>To ensure no hidden rules remain across the tenant, I wrote the following PowerShell script:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$mailboxes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-EXOMailbox</span><span class="w"> </span><span class="nt">-ResultSize</span><span class="w"> </span><span class="nx">Unlimited</span><span class="w">
</span><span class="nv">$output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">

</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$mailbox</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$mailboxes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$hiddenrules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-InboxRule</span><span class="w"> </span><span class="nt">-Mailbox</span><span class="w"> </span><span class="nv">$mailbox</span><span class="w"> </span><span class="nt">-IncludeHidden</span><span class="w"> </span><span class="o">|</span><span class="w">
        </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-notin</span><span class="w"> </span><span class="p">(</span><span class="n">Get-InboxRule</span><span class="w"> </span><span class="nt">-Mailbox</span><span class="w"> </span><span class="nv">$mailbox</span><span class="p">)</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-and</span><span class="w">
            </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="s2">"Junk E-Mail Rule"</span><span class="w">
        </span><span class="p">}</span><span class="w">

    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$hiddenrules</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$rule</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$hiddenrules</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nv">$output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span><span class="n">PSCustomObject</span><span class="p">]@{</span><span class="w">
                </span><span class="nx">Email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$mailbox</span><span class="err">.</span><span class="nx">UserPrincipalName</span><span class="w">
                </span><span class="nx">Rule</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">$rule</span><span class="err">.</span><span class="nx">Name</span><span class="w">
            </span><span class="p">}</span><span class="w">
            </span><span class="n">Write-Host</span><span class="w"> </span><span class="nv">$mailbox</span><span class="o">.</span><span class="nf">UserPrincipalName</span><span class="w"> </span><span class="nv">$rule</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-ForegroundColor</span><span class="w"> </span><span class="nx">Red</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Export-Csv</span><span class="w"> </span><span class="s2">"OUTPUT_PATH.csv"</span><span class="w"> </span><span class="nt">-NoTypeInformation</span><span class="w">
</span></code></pre></div></div>
<p>This produces a list of mailboxes with suspicious hidden rules.</p>

<p><br /></p>

<h2 id="inspecting-rule-behaviour">Inspecting Rule Behaviour</h2>
<p>To understand what a hidden rule actually does:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
</span><span class="nv">$rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-InboxRule</span><span class="w"> </span><span class="nt">-Mailbox</span><span class="w"> </span><span class="s2">"EXCHANGE_EMAIL"</span><span class="w"> </span><span class="nt">-IncludeHidden</span><span class="w"> </span><span class="o">|</span><span class="w">
    </span><span class="n">Select-Object</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">Description</span><span class="w">

</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$rule</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$rules</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$rule</span><span class="o">.</span><span class="nf">Description</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s2">"</span><span class="se">`r</span><span class="s2">?</span><span class="se">`n</span><span class="s2">"</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="w">
    </span><span class="nv">$output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span><span class="n">PSCustomObject</span><span class="p">]@{</span><span class="w">
        </span><span class="nx">RuleName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$rule</span><span class="err">.</span><span class="nx">Name</span><span class="w">
        </span><span class="nx">RuleDesc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$desc</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Export-Csv</span><span class="w"> </span><span class="s2">"OUTPUT_PATH.csv"</span><span class="w"> </span><span class="nt">-NoTypeInformation</span><span class="w">
</span></code></pre></div></div>

<figure>
  <img src="/assets/images/hidden-rules/description-output.webp" alt="Rule Description Output" width="1000" />
  <figcaption>Rule Description Output</figcaption>
</figure>
<p>This allows you to determine whether the rule is malicious or benign.</p>

<p><br /></p>

<h2 id="final-thoughts">Final Thoughts</h2>
<p>A compromised account cannot always be considered secure after a password reset and session token revocation alone.</p>

<p>Hidden inbox rules are a powerful persistence mechanism that can:</p>
<ul>
  <li>Suppress security alerts</li>
  <li>Hide user communications</li>
  <li>Enable long-term access to information without detection</li>
</ul>

<p>Microsoft does not currently classify this behaviour as a vulnerability, as it requires authenticated access. However, it is difficult to identify any legitimate use case for completely hiding inbox rules.</p>

<p>As a result of this incident, we now:</p>
<ul>
  <li>Periodically scan for hidden inbox rules</li>
  <li>Continue to restrict external email forwarding</li>
  <li>Complete an in-depth forensic investigation into any breaches</li>
</ul>

<p>What began as a routine Monday quickly turned into a deep investigation, remediation effort, and a reminder that mailbox persistence techniques can be subtle yet highly effective.</p>

<p>Stay vigilant — and don’t rely on the Rules GUI alone.</p>


        </div>
      </article>
    </main>

    <footer class="site-footer">
      &copy; 2026 Ritchie Caruso
    </footer>
    <script>
      (function(){
        var root = document.documentElement;
        var toggle = document.getElementById('theme-toggle');
        if(!toggle) return;

        function applyTheme(theme){
          if(theme === 'dark') root.classList.add('dark');
          else root.classList.remove('dark');
        }

        var stored = localStorage.getItem('theme');
        if(stored) applyTheme(stored);
        else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');

        function updateToggleState(){
          var isDark = root.classList.contains('dark');
          toggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
        }

        updateToggleState();

        toggle.addEventListener('click', function(){
          var isDark = root.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          updateToggleState();
        });
      })();

      // Hamburger menu toggle
      (function(){
        var hamburger = document.getElementById('hamburger');
        var siteRight = document.querySelector('.site-right');
        if(!hamburger || !siteRight) return;

        hamburger.addEventListener('click', function(){
          var isExpanded = siteRight.classList.toggle('active');
          hamburger.classList.toggle('active');
          hamburger.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e){
          if(!hamburger.contains(e.target) && !siteRight.contains(e.target)){
            siteRight.classList.remove('active');
            hamburger.classList.remove('active');
            hamburger.setAttribute('aria-expanded', 'false');
          }
        });

        // Close menu on window resize above mobile breakpoint
        var resizeTimer;
        window.addEventListener('resize', function(){
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(function(){
            if(window.innerWidth > 768){
              siteRight.classList.remove('active');
              hamburger.classList.remove('active');
              hamburger.setAttribute('aria-expanded', 'false');
            }
          }, 250);
        });
      })();

      // Copy code button functionality
      (function(){
        function wrapCodeBlocks(){
          var pres = document.querySelectorAll('pre');
          pres.forEach(function(pre){
            if(pre.parentElement.classList.contains('code-block-wrapper')) return;
            
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            var button = document.createElement('button');
            button.className = 'copy-code-button';
            button.textContent = 'Copy';
            button.setAttribute('aria-label', 'Copy code to clipboard');
            
            button.addEventListener('click', function(){
              var code = pre.querySelector('code') || pre;
              var text = code.textContent;
              
              navigator.clipboard.writeText(text).then(function(){
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(function(){
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              }).catch(function(err){
                console.error('Failed to copy:', err);
              });
            });
            
            wrapper.appendChild(button);
          });
        }
        
        if(document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', wrapCodeBlocks);
        } else {
          wrapCodeBlocks();
        }
      })();
    </script>
  </body>
</html>
